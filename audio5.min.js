(function(ns,$win,factory){"use strict";var module=$win.module,define=$win.define;void 0!==module&&module.exports?module.exports=factory(ns,$win):"function"==typeof define&&define.amd?define(function(){return factory(ns,$win)}):$win[ns]=factory(ns,$win)})("Audio5js",this,function(ns,$win){"use strict";function AudioError(message){this.message=message}function cloneObject(obj){var i,clone={};for(i in obj)clone[i]="object"==typeof obj[i]?cloneObject(obj[i]):obj[i];return clone}var ActiveXObject=$win.ActiveXObject,Audio=$win.Audio;AudioError.prototype=Error();var extend=function(target,mixin){var name,m=cloneObject(mixin);for(name in m)m.hasOwnProperty(name)&&(target[name]=m[name]);return target},include=function(target,mixin){return extend(target.prototype,mixin)},Pubsub={channels:{},on:function(evt,fn,ctx){this.channels[evt]=this.channels[evt]||[],this.channels[evt].push({fn:fn,ctx:ctx})},off:function(evt,fn){if(void 0!==this.channels[evt]){var i,l;for(i=0,l=this.channels[evt].length;l>i;i++){var sub=this.channels[evt][i].fn;if(sub===fn){this.channels[evt].splice(i,1);break}}}},trigger:function(evt){if(this.channels.hasOwnProperty(evt)){var i,l,args=Array.prototype.slice.call(arguments,1);for(i=0,l=this.channels[evt].length;l>i;i++){var sub=this.channels[evt][i];"function"==typeof sub.fn&&sub.fn.apply(sub.ctx,args)}}}},util={flash_embed_code:function(){var prefix,s='<param name="movie" value="$2?playerInstance='+ns+".flash.instances['$1']&datetime=$3\"/>"+'<param name="wmode" value="transparent"/>'+'<param name="allowscriptaccess" value="always" />'+"</object>";return prefix=ActiveXObject?'<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="1" height="1" id="$1">':'<object type="application/x-shockwave-flash" data="$2?playerInstance='+ns+'.flash.instances[\'$1\']&datetime=$3" width="1" height="1" id="$1" >',prefix+s}(),can_play:function(mime_type){var mime_str,a=document.createElement("audio");switch(mime_type){case"mp3":mime_str='audio/mpeg; codecs="mp3"';break;case"vorbis":mime_str='audio/ogg; codecs="vorbis"';break;case"opus":mime_str='audio/ogg; codecs="opus"';break;case"webm":mime_str='audio/webm; codecs="vorbis"';break;case"mp4":mime_str='audio/mp4; codecs="mp4a.40.5"';break;case"wav":mime_str='audio/wav; codecs="1"'}if(void 0===mime_str)throw Error("Unspecified Audio Mime Type");return!!a.canPlayType&&""!==a.canPlayType(mime_str)},has_flash:function(){var r=!1;if(navigator.plugins&&navigator.plugins.length&&navigator.plugins["Shockwave Flash"])r=!0;else if(navigator.mimeTypes&&navigator.mimeTypes.length){var mimeType=navigator.mimeTypes["application/x-shockwave-flash"];r=mimeType&&mimeType.enabledPlugin}else try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),r=!0}catch(e){}return r}(),embedFlash:function(swf_location,id){var d=document.createElement("div");d.style.position="absolute",d.style.width="1px",d.style.height="1px",d.style.top="-2px";var flashSource=this.flash_embed_code.replace(/\$1/g,id);return flashSource=flashSource.replace(/\$2/g,swf_location),flashSource=flashSource.replace(/\$3/g,(new Date).getTime()+Math.random()),d.innerHTML=flashSource,document.body.appendChild(d),document.getElementById(id)},formatTime:function(seconds){var result,hours=parseInt(seconds/3600,10)%24,minutes=parseInt(seconds/60,10)%60,secs=parseInt(seconds%60,10),fragment=(10>minutes?"0"+minutes:minutes)+":"+(10>secs?"0"+secs:secs);return result=hours>0?(10>hours?"0"+hours:hours)+":"+fragment:fragment}};util.use_flash=util.can_play("mp3");var Audio5js,FlashAudioPlayer,HTML5AudioPlayer,AudioAttributes={playing:!1,vol:1,duration:0,position:0,load_percent:0,seekable:!1};FlashAudioPlayer=function(){if(util.use_flash&&!util.has_flash)throw Error("Flash Plugin Missing");include(FlashAudioPlayer,Pubsub),include(FlashAudioPlayer,AudioAttributes)},FlashAudioPlayer.prototype={init:function(swf_src){Audio5js.flash.count+=1,this.id=ns+Audio5js.flash.count,Audio5js.flash.instances[this.id]=this,this.embed(swf_src)},embed:function(swf_src){this.audio=util.embedFlash(swf_src,this.id)},eiReady:function(){this.trigger("ready")},eiTimeUpdate:function(position,duration,seekable){this.position=position,this.duration=duration,this.seekable=seekable,this.playing&&this.trigger("timeupdate",position,this.seekable?duration:null)},eiProgress:function(percent){this.load_percent=percent,this.trigger("progress",percent)},eiLoadError:function(msg){this.trigger("error",msg)},eiPlay:function(){this.playing=!0,this.trigger("play")},eiPause:function(){this.playing=!1,this.trigger("pause")},eiEnded:function(){this.playing=!1,this.trigger("ended")},eiCanPlay:function(){this.trigger("canplay")},reset:function(){this.seekable=!1,this.duration=0,this.position=0,this.load_percent=0},load:function(url){this.reset(),this.audio.load(url)},play:function(){this.audio.pplay()},pause:function(){this.audio.ppause()},volume:function(v){return void 0===v||isNaN(parseInt(v,10))?this.vol:(this.audio.setVolume(v),this.vol=v,void 0)},seek:function(position){try{this.audio.seekTo(position),this.position=position}catch(e){}}},HTML5AudioPlayer=function(){include(HTML5AudioPlayer,Pubsub),include(HTML5AudioPlayer,AudioAttributes)},HTML5AudioPlayer.prototype={init:function(){this.audio=new Audio,this.audio.autoplay=!1,this.audio.preload="auto",this.audio.autobuffer=!0,this.bindEvents(),this.trigger("ready")},bindEvents:function(){this.audio.addEventListener("timeupdate",this.onTimeUpdate.bind(this)),this.audio.addEventListener("play",this.onPlay.bind(this)),this.audio.addEventListener("pause",this.onPause.bind(this)),this.audio.addEventListener("ended",this.onEnded.bind(this)),this.audio.addEventListener("canplay",this.onLoad.bind(this)),this.audio.addEventListener("error",this.onError.bind(this))},onPlay:function(){this.playing=!0,this.trigger("play")},onPause:function(){this.playing=!1,this.trigger("pause")},onEnded:function(){this.playing=!1,this.trigger("ended")},onTimeUpdate:function(){null!==this.audio.buffered&&this.audio.buffered.length&&this.playing&&(this.position=this.audio.currentTime,this.duration=1/0===this.audio.duration?null:this.audio.duration,this.trigger("timeupdate",this.position,this.duration))},onLoad:function(){this.seekable=this.audio.seekable&&this.audio.seekable.length>0,this.seekable&&(this.timer=setInterval(this.onProgress.bind(this),250)),this.trigger("canplay")},onProgress:function(){null!==this.audio.buffered&&this.audio.buffered.length&&(this.load_percent=parseInt(100*(this.audio.buffered.end(this.audio.buffered.length-1)/this.audio.duration),10),this.trigger("progress",this.load_percent),this.load_percent>=100&&this.clearLoadProgress())},onError:function(e){this.trigger("error",e)},clearLoadProgress:function(){void 0!==this.timer&&(clearInterval(this.timer),delete this.timer)},reset:function(){this.clearLoadProgress(),this.seekable=!1,this.duration=0,this.position=0,this.load_percent=0},load:function(url){this.reset(),this.audio.setAttribute("src",url),this.audio.load()},play:function(){this.audio.play()},pause:function(){this.audio.pause()},volume:function(v){return void 0===v||isNaN(parseInt(v,10))?this.vol:(this.audio.setVolume(v),this.vol=v,void 0)},seek:function(position){this.position=position,this.audio.currentTime=position,this.play()}};var settings={swf_path:"/swf/audiojs.swf",throw_errors:!0,format_time:!0,codecs:["mp3"]};return Audio5js=function(s){include(Audio5js,Pubsub),include(Audio5js,AudioAttributes),s=s||{};var k;for(k in settings)settings.hasOwnProperty(k)&&!s.hasOwnProperty(k)&&(s[k]=settings[k]);this.init(s)},Audio5js.flash={instances:{},count:0},Audio5js.can_play=function(mime_type){return util.can_play(mime_type)},Audio5js.prototype={init:function(s){this.settings=s,this.audio=this.getPlayer(),this.bindAudioEvents(),this.settings.use_flash?this.audio.init(s.swf_path):this.audio.init()},getPlayer:function(){var i,l,player;for(i=0,l=this.settings.codecs.length;l>i;i++){var codec=this.settings.codecs[i];if(Audio5js.can_play(codec)){player=new HTML5AudioPlayer,this.settings.use_flash=!1,this.settings.player={engine:"html",codec:codec};break}}return void 0===player&&(this.settings.use_flash=!Audio5js.can_play("mp3"),player=this.settings.use_flash?new FlashAudioPlayer:new HTML5AudioPlayer,this.settings.player={engine:this.settings.use_flash?"flash":"html",codec:"mp3"}),player},bindAudioEvents:function(){this.audio.on("ready",this.onReady,this),this.audio.on("play",this.onPlay,this),this.audio.on("pause",this.onPause,this),this.audio.on("ended",this.onEnded,this),this.audio.on("canplay",this.onCanPlay,this),this.audio.on("timeupdate",this.onTimeUpdate,this),this.audio.on("progress",this.onProgress,this),this.audio.on("error",this.onError,this)},load:function(url){this.audio.load(url),this.trigger("load")},play:function(){this.audio.play()},pause:function(){this.audio.pause()},playPause:function(){this[this.playing?"pause":"play"]()},volume:function(v){return void 0===v||isNaN(parseInt(v,10))?this.vol:(this.audio.volume(v),this.vol=v,void 0)},seek:function(position){this.audio.seek(position),this.position=position},onReady:function(){"function"==typeof this.settings.ready&&this.settings.ready.call(this,this.settings.player)},onPlay:function(){this.playing=!0,this.trigger("play")},onPause:function(){this.playing=!1,this.trigger("pause")},onEnded:function(){this.playing=!1,this.trigger("ended")},onError:function(){var error=new AudioError("Audio Error. Failed to Load Audio");if(this.settings.throw_errors)throw error;this.trigger("error",error)},onCanPlay:function(){this.trigger("canplay")},onTimeUpdate:function(position,duration){this.position=this.settings.format_time?util.formatTime(position):position,this.duration!==duration&&(this.duration=this.settings.format_time&&null!==duration?util.formatTime(duration):duration),this.trigger("timeupdate",this.position,this.duration)},onProgress:function(loaded){this.load_percent=loaded,this.trigger("progress",loaded)}},Audio5js});